---
import { siteConfig } from "../config";

const services = siteConfig.services;

interface Props {
  galleryImages: Array<{
    id: string;
    url: string;
    title: string;
    category: string;
  }>;
}

const { galleryImages } = Astro.props;
---

<section id="sluzby" class="services-section">
  <div class="container">
    <h2
      class="section-title glass-card-gradient"
      style="--shimmer-delay: 0.7s; --shimmer-duration: 3.8s;"
    >
      Naše služby
    </h2>
    <p class="text-center text-muted">
      Komplexní sklenářské služby pro každou potřebu
    </p>

    <div class="services-grid">
      {
        services.map((service) => (
          <div class="service-card glass-card">
            <div class="service-content">
              <h3>{service.title}</h3>
              <p>{service.description}</p>
              <ul class="service-features">
                {service.features.map((feature) => (
                  <li>✓ {feature}</li>
                ))}
              </ul>
            </div>
            <button
              class="btn btn-glass gallery-trigger"
              data-category={service.galleryCategory}
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="margin-right: 0.5rem;"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                <circle cx="8.5" cy="8.5" r="1.5" />
                <polyline points="21 15 16 10 5 21" />
              </svg>
              Zobrazit galerii
            </button>
          </div>
        ))
      }
    </div>

    <div class="additional-services glass-card">
      <h3>Další služby a materiály</h3>
      <div class="service-list">
        {
          siteConfig.additionalServices.map((service) => (
            <div class="service-item">
              <strong>{service.title}</strong>
              <p>{service.description}</p>
            </div>
          ))
        }
      </div>
    </div>
  </div>

  <!-- Hidden gallery images data -->
  <div
    id="gallery-data"
    data-images={JSON.stringify(galleryImages)}
    style="display: none;"
  >
  </div>
</section>

<script>
  import PhotoSwipeLightbox from "photoswipe/lightbox";

  interface GalleryImage {
    id: string;
    url: string;
    title: string;
    category: string;
  }

  const galleryDataEl = document.getElementById("gallery-data");
  const galleryImages: GalleryImage[] = galleryDataEl
    ? JSON.parse(galleryDataEl.getAttribute("data-images") || "[]")
    : [];

  const lightbox = new PhotoSwipeLightbox({
    pswpModule: () => import("photoswipe"),
    dataSource: [],
    showHideAnimationType: "zoom",
    bgOpacity: 0.8,
    loop: true,
    closeOnVerticalDrag: true,
    pinchToClose: true,
    padding: { top: 60, bottom: 100, left: 20, right: 20 },
  });

  // Add thumbnails UI after PhotoSwipe opens
  lightbox.on("uiRegister", function () {
    lightbox.pswp?.ui?.registerElement({
      name: "thumbnails-wrapper",
      order: 9,
      isButton: false,
      appendTo: "root",
      onInit: (el: HTMLElement) => {
        el.className = "pswp__thumbnails";

        const updateThumbnails = () => {
          if (!lightbox.pswp) return;

          const currentDataSource = lightbox.options.dataSource as any[];
          el.innerHTML = "";

          currentDataSource.forEach((item, index) => {
            const thumb = document.createElement("img");
            thumb.src = item.src;
            thumb.className = "pswp__thumbnail";
            thumb.alt = item.alt || "";

            if (index === lightbox.pswp!.currIndex) {
              thumb.classList.add("pswp__thumbnail--active");
            }

            thumb.addEventListener("click", () => {
              lightbox.pswp?.goTo(index);
            });

            el.appendChild(thumb);
          });
        };

        updateThumbnails();

        lightbox.pswp?.on("change", () => {
          const thumbs = el.querySelectorAll(".pswp__thumbnail");
          thumbs.forEach((thumb, index) => {
            if (index === lightbox.pswp!.currIndex) {
              thumb.classList.add("pswp__thumbnail--active");
            } else {
              thumb.classList.remove("pswp__thumbnail--active");
            }
          });
        });
      },
    });
  });

  lightbox.init();

  // Gallery trigger handlers
  const triggers = document.querySelectorAll(".gallery-trigger");

  triggers.forEach((trigger) => {
    trigger.addEventListener("click", (e) => {
      e.preventDefault();
      const category = trigger.getAttribute("data-category");

      if (category) {
        const categoryImages = galleryImages.filter(
          (img) => img.category === category
        );

        if (categoryImages.length > 0) {
          // Create PhotoSwipe data source
          const dataSource = categoryImages.map((img) => ({
            src: img.url,
            width: 1200,
            height: 900,
            alt: img.title,
            title: img.title,
          }));

          lightbox.options.dataSource = dataSource;
          lightbox.loadAndOpen(0);
        } else {
          alert(
            `Galerie pro kategorii "${category}" zatím neobsahuje žádné fotky.`
          );
        }
      }
    });
  });
</script>

<style>
  .service-card {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .service-content {
    flex: 1;
  }

  .gallery-trigger {
    margin-top: 1.5rem;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>
